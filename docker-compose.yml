version: '3.8'

services:
  postgres:
    image: postgres:15-alpine
    container_name: sports-postgres
    environment:
      POSTGRES_DB: sports_prediction
      POSTGRES_USER: sports_user
      POSTGRES_PASSWORD: sports_password
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/init-db.sql
    networks:
      - sports-network

  redis:
    image: redis:7-alpine
    container_name: sports-redis
    ports:
      - "6379:6379"
    volumes:
      - redis_data:/data
    networks:
      - sports-network

  # API Gateway service
  api-gateway:
    build:
      context: ./backend
      dockerfile: api-gateway/Dockerfile
    container_name: sports-api-gateway
    ports:
      - "8080:8080"
    environment:
      - API_GATEWAY_PORT=8080
      - USER_SERVICE_ENDPOINT=user-service:8084
      - CONTEST_SERVICE_ENDPOINT=contest-service:8085
      - PREDICTION_SERVICE_ENDPOINT=prediction-service:8086
      - SCORING_SERVICE_ENDPOINT=scoring-service:8087
      - SPORTS_SERVICE_ENDPOINT=sports-service:8088
      - NOTIFICATION_SERVICE_ENDPOINT=notification-service:8089
      - CHALLENGE_SERVICE_ENDPOINT=challenge-service:8090
      - JWT_SECRET=your_jwt_secret_key_here
      - CORS_ALLOWED_ORIGINS=*
      - LOG_LEVEL=info
    depends_on:
      - postgres
      - redis
    networks:
      - sports-network
    profiles:
      - services

  # User service
  user-service:
    build:
      context: ./backend
      dockerfile: user-service/Dockerfile
    container_name: sports-user-service
    ports:
      - "8084:8084"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your_jwt_secret_key_here
      - JWT_EXPIRATION=24h
      - USER_SERVICE_PORT=8084
    depends_on:
      - postgres
      - redis
    networks:
      - sports-network
    profiles:
      - services

  # Contest service
  contest-service:
    build:
      context: ./backend
      dockerfile: contest-service/Dockerfile
    container_name: sports-contest-service
    ports:
      - "8085:8085"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your_jwt_secret_key_here
      - CONTEST_SERVICE_PORT=8085
    depends_on:
      - postgres
      - redis
    networks:
      - sports-network
    profiles:
      - services

  # Prediction service
  prediction-service:
    build:
      context: ./backend
      dockerfile: prediction-service/Dockerfile
    container_name: sports-prediction-service
    ports:
      - "8086:8086"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - JWT_SECRET=your_jwt_secret_key_here
      - PREDICTION_SERVICE_PORT=8086
      - CONTEST_SERVICE_ENDPOINT=contest-service:8085
      - LOG_LEVEL=info
    depends_on:
      - postgres
      - contest-service
    networks:
      - sports-network
    profiles:
      - services

  # Scoring service
  scoring-service:
    build:
      context: ./backend
      dockerfile: scoring-service/Dockerfile
    container_name: sports-scoring-service
    ports:
      - "8087:8087"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your_jwt_secret_key_here
      - SCORING_SERVICE_PORT=8087
      - CONTEST_SERVICE_ENDPOINT=contest-service:8085
      - PREDICTION_SERVICE_ENDPOINT=prediction-service:8086
      - LOG_LEVEL=info
    depends_on:
      - postgres
      - redis
    networks:
      - sports-network
    profiles:
      - services

  # Sports service
  sports-service:
    build:
      context: ./backend
      dockerfile: sports-service/Dockerfile
    container_name: sports-service
    ports:
      - "8088:8088"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - JWT_SECRET=your_jwt_secret_key_here
      - SPORTS_SERVICE_PORT=8088
      - LOG_LEVEL=info
    depends_on:
      - postgres
    networks:
      - sports-network
    profiles:
      - services

  # Notification service
  notification-service:
    build:
      context: ./backend
      dockerfile: notification-service/Dockerfile
    container_name: sports-notification-service
    ports:
      - "8089:8089"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - REDIS_URL=redis://redis:6379
      - JWT_SECRET=your_jwt_secret_key_here
      - NOTIFICATION_SERVICE_PORT=8089
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN:-}
      - TELEGRAM_ENABLED=${TELEGRAM_ENABLED:-false}
      - SMTP_HOST=${SMTP_HOST:-}
      - SMTP_PORT=${SMTP_PORT:-587}
      - SMTP_USER=${SMTP_USER:-}
      - SMTP_PASSWORD=${SMTP_PASSWORD:-}
      - SMTP_FROM=${SMTP_FROM:-}
      - EMAIL_ENABLED=${EMAIL_ENABLED:-false}
      - WORKER_POOL_SIZE=5
      - LOG_LEVEL=info
    depends_on:
      - postgres
      - redis
    networks:
      - sports-network
    profiles:
      - services

  # Challenge service
  challenge-service:
    build:
      context: ./backend
      dockerfile: challenge-service/Dockerfile
    container_name: sports-challenge-service
    ports:
      - "8090:8090"
    environment:
      - DATABASE_URL=postgres://sports_user:sports_password@postgres:5432/sports_prediction?sslmode=disable
      - JWT_SECRET=your_jwt_secret_key_here
      - CHALLENGE_SERVICE_PORT=8090
      - LOG_LEVEL=info
    depends_on:
      - postgres
    networks:
      - sports-network
    profiles:
      - services

  # Telegram bot
  telegram-bot:
    build:
      context: .
      dockerfile: bots/telegram/Dockerfile
    container_name: sports-telegram-bot
    restart: unless-stopped
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - USER_SERVICE_ENDPOINT=user-service:8084
      - CONTEST_SERVICE_ENDPOINT=contest-service:8085
      - PREDICTION_SERVICE_ENDPOINT=prediction-service:8086
      - SCORING_SERVICE_ENDPOINT=scoring-service:8087
      - NOTIFICATION_SERVICE_ENDPOINT=notification-service:8089
      - LOG_LEVEL=info
    depends_on:
      - user-service
      - contest-service
      - scoring-service
      - notification-service
    networks:
      - sports-network
    profiles:
      - services

  # Frontend service placeholder
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    container_name: sports-frontend
    ports:
      - "3000:3000"
    environment:
      - REACT_APP_API_URL=http://api-gateway:8080
    depends_on:
      - api-gateway
    networks:
      - sports-network
    profiles:
      - services

volumes:
  postgres_data:
  redis_data:

networks:
  sports-network:
    driver: bridge
