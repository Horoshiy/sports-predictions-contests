# Система Генерации Тестовых Данных

Платформа Sports Prediction Contests включает в себя комплексную систему генерации тестовых данных, которая заполняет базу данных разработки реалистичными тестовыми данными. Система генерирует пользователей, конкурсы, прогнозы, спортивные данные и все связанные сущности с правильными связями и реалистичными значениями.

## Обзор

Система генерации данных предоставляет:

- **Реалистичная Генерация Данных**: Использует библиотеку gofakeit для создания аутентичных спортивных данных
- **Настраиваемые Объёмы Данных**: Три предустановленных размера (малый/средний/большой) для различных потребностей разработки
- **Ссылочная Целостность**: Обеспечивает правильное поддержание всех связей внешних ключей
- **Воспроизводимые Результаты**: Используйте одно и то же значение seed для генерации идентичных наборов данных
- **Координация Между Сервисами**: Последовательно заполняет данные во всех микросервисах

## Быстрый Старт

### Предварительные Требования

- База данных PostgreSQL запущена (по умолчанию localhost:5432)
- Установлен Go 1.21+
- Установлены зависимости проекта (`make setup`)

### Базовое Использование

```bash
# Заполнение малым набором данных (рекомендуется для разработки)
make seed-small

# Заполнение средним набором данных (хорошо для тестирования)
make seed-medium

# Заполнение большим набором данных (тестирование производительности)
make seed-large

# Тестирование конфигурации без заполнения
make seed-test
```

### Пользовательское Заполнение

```bash
# Использование shell-скрипта напрямую с пользовательскими параметрами
./scripts/seed-data.sh --size medium --seed 123

# Установка переменных окружения для пользовательского заполнения
SEED_SIZE=medium SEED_VALUE=456 make seed-custom
```

## Предустановки Размеров Данных

### Малый Набор Данных (По умолчанию)
- **Пользователи**: 20 (с профилями и настройками)
- **Виды спорта**: 3 (Футбол, Футбол американский, Баскетбол)
- **Лиги**: 6 (по 2 на вид спорта)
- **Команды**: 24 (по 8 на вид спорта)
- **Матчи**: 50 (различные расписания и статусы)
- **Конкурсы**: 8 (разные виды спорта и конфигурации)
- **Прогнозы**: 200 (реалистичные прогнозы пользователей)
- **Пользовательские Команды**: 4 (командные турниры)

**Случай использования**: Ежедневная разработка, быстрое тестирование, разработка функций

### Средний Набор Данных
- **Пользователи**: 100
- **Виды спорта**: 5
- **Лиги**: 15
- **Команды**: 60
- **Матчи**: 200
- **Конкурсы**: 25
- **Прогнозы**: 1000
- **Пользовательские Команды**: 15

**Случай использования**: Интеграционное тестирование, стресс-тестирование UI, подготовка демо

### Большой Набор Данных
- **Пользователи**: 500
- **Виды спорта**: 8
- **Лиги**: 30
- **Команды**: 120
- **Матчи**: 800
- **Конкурсы**: 50
- **Прогнозы**: 5000
- **Пользовательские Команды**: 30

**Случай использования**: Тестирование производительности, нагрузочное тестирование, симуляция продакшена

## Типы Генерируемых Данных

### Основные Сущности

#### Пользователи
- Реалистичные имена и email-адреса
- Безопасные хеши паролей (bcrypt)
- Полные профили пользователей с биографией, аватаром, местоположением, социальными ссылками
- Настройки пользователей (язык, часовой пояс, уведомления, тема)

#### Спортивные Данные
- Аутентичные названия и описания видов спорта
- Реалистичные названия команд (комбинации город + талисман)
- Профессиональные структуры лиг
- Расписания матчей с реалистичным временем
- Результаты матчей с подробной статистикой

#### Конкурсы
- Разнообразные названия и описания конкурсов
- Различные типы спорта и правила
- Реалистичные диапазоны дат и лимиты участников
- Множественные типы статусов (черновик, активный, завершённый)

#### Прогнозы
- Множественные типы прогнозов (результат матча, точный счёт, больше/меньше и т.д.)
- Реалистичные данные прогнозов в формате JSON
- Правильные связи пользователь-конкурс-матч
- Результаты подсчёта очков с индикаторами правильности

### Продвинутые Функции

#### Система Подсчёта Очков
- Индивидуальные очки прогнозов с временными коэффициентами
- Записи в таблице лидеров с рейтингами
- Отслеживание серий пользователей (текущие и максимальные серии)
- Реалистичное распределение очков

#### Командные Турниры
- Созданные пользователями команды с капитанами и участниками
- Коды приглашений команд и управление членством
- Участие команд в конкурсах

#### Уведомления
- Различные типы уведомлений (обновления конкурсов, результаты, достижения)
- Многоканальные настройки (в приложении, email, Telegram)
- Отслеживание статуса прочитано/не прочитано
- Реалистичная история уведомлений

## Конфигурация

### Переменные Окружения

```bash
# Настройки генерации данных
SEED_SIZE=small          # Предустановка размера данных (small/medium/large)
SEED_VALUE=42           # Случайное зерно для воспроизводимых данных
BATCH_SIZE=100          # Размер пакета для вставки в базу данных

# Подключение к базе данных
DATABASE_URL=postgres://sports_user:sports_password@localhost:5432/sports_prediction?sslmode=disable
```

### Опции Командной Строки

```bash
./scripts/seed-data.sh [ОПЦИИ]

Опции:
  --size SIZE    Предустановка размера данных: small, medium, large
  --seed SEED    Случайное зерно для воспроизводимых данных
  --test         Тестовый режим - проверка без заполнения
  --help         Показать справочное сообщение
```

## Детали Реализации

### Архитектура

Система заполнения состоит из нескольких компонентов:

- **Config**: Управляет конфигурацией заполнения и предустановками размеров данных
- **Factory**: Генерирует поддельные данные используя библиотеку gofakeit
- **SportsDataGenerator**: Специализированный генератор для спортивных данных
- **Coordinator**: Оркестрирует заполнение во всех сервисах с правильными зависимостями
- **Models**: Специфичные для заполнения структуры данных, отражающие модели сервисов

### Порядок Зависимостей

Данные заполняются в правильном порядке зависимостей для поддержания ссылочной целостности:

1. **Пользователи** (на них ссылается всё)
2. **Виды спорта** (на них ссылаются лиги, команды, конкурсы)
3. **Лиги** (зависят от видов спорта)
4. **Команды** (зависят от видов спорта)
5. **Матчи** (зависят от лиг и команд)
6. **Конкурсы** (зависят от пользователей и видов спорта)
7. **Прогнозы** (зависят от пользователей, конкурсов, матчей)
8. **Данные Подсчёта Очков** (зависят от прогнозов)
9. **Пользовательские Команды** (зависят от пользователей)
10. **Уведомления** (зависят от пользователей)

### Безопасность Транзакций

Все операции заполнения обёрнуты в транзакции базы данных для обеспечения:
- **Атомарности**: Либо все данные заполняются, либо никакие
- **Согласованности**: База данных остаётся в валидном состоянии при сбое заполнения
- **Откат**: Автоматическая очистка при ошибках

## Примеры Использования

### Рабочий Процесс Разработки

```bash
# Запуск свежей среды разработки
make docker-up
make seed-small

# Запуск фронтенда и исследование
make dev
# Открыть http://localhost:3000
```

### Тестирование Различных Сценариев

```bash
# Генерация согласованных тестовых данных
./scripts/seed-data.sh --seed 123

# Позже, повторная генерация идентичных данных
./scripts/seed-data.sh --seed 123
```

### Тестирование Производительности

```bash
# Генерация большого набора данных для нагрузочного тестирования
make seed-large

# Мониторинг производительности базы данных
docker exec -it sports-postgres psql -U sports_user -d sports_prediction -c "
  SELECT schemaname,tablename,n_tup_ins,n_tup_upd,n_tup_del 
  FROM pg_stat_user_tables 
  ORDER BY n_tup_ins DESC;
"
```

## Устранение Неполадок

### Частые Проблемы

#### Сбой Подключения к Базе Данных
```bash
# Проверить, запущен ли PostgreSQL
docker ps | grep postgres

# Запустить базу данных при необходимости
make docker-up

# Проверить подключение вручную
psql postgres://sports_user:sports_password@localhost:5432/sports_prediction
```

#### Проблемы с Go Модулями
```bash
# Убедиться, что вы в корне проекта
pwd  # Должен показать корневую директорию проекта

# Обновить зависимости
cd backend/shared && go mod tidy
```

#### Отказано в Доступе к Скрипту
```bash
# Сделать скрипт исполняемым
chmod +x scripts/seed-data.sh
```

### Команды Проверки

```bash
# Тестирование конфигурации заполнения
make seed-test

# Проверка количества сгенерированных данных
docker exec -it sports-postgres psql -U sports_user -d sports_prediction -c "
  SELECT 
    'users' as table_name, COUNT(*) as count FROM users
  UNION ALL
  SELECT 'contests', COUNT(*) FROM contests
  UNION ALL  
  SELECT 'predictions', COUNT(*) FROM predictions;
"

# Проверка связей данных
docker exec -it sports-postgres psql -U sports_user -d sports_prediction -c "
  SELECT c.title, COUNT(p.id) as prediction_count 
  FROM contests c 
  LEFT JOIN predictions p ON c.id = p.contest_id 
  GROUP BY c.id, c.title 
  ORDER BY prediction_count DESC;
"
```

### Мониторинг Производительности

```bash
# Мониторинг прогресса заполнения
tail -f /tmp/seeding.log

# Проверка размера базы данных после заполнения
docker exec -it sports-postgres psql -U sports_user -d sports_prediction -c "
  SELECT pg_size_pretty(pg_database_size('sports_prediction')) as database_size;
"
```

## Лучшие Практики

### Разработка

1. **Используйте Малый Набор Данных**: Начинайте с `make seed-small` для ежедневной разработки
2. **Согласованные Зёрна**: Используйте одно и то же значение зерна среди участников команды для согласованных тестовых данных
3. **Регулярное Обновление**: Периодически перезаполняйте для тестирования со свежими данными
4. **Сначала Тестовый Режим**: Используйте `make seed-test` для проверки конфигурации перед заполнением

### Тестирование

1. **Изолированные Среды**: Используйте разные базы данных для разных тестовых сценариев
2. **Воспроизводимые Тесты**: Используйте фиксированные значения зерна для согласованных результатов тестов
3. **Базовые Показатели Производительности**: Используйте большие наборы данных для установления базовых показателей производительности
4. **Проверка Данных**: Проверяйте целостность данных после заполнения

### Соображения Продакшена

⚠️ **Предупреждение**: Никогда не запускайте систему заполнения против продакшн баз данных!

- Заполнение предназначено только для разработки и тестирования
- Сгенерированные данные включают поддельные email-адреса и пароли
- Используйте переменные окружения для предотвращения случайного заполнения продакшена
- Учитывайте регулирования конфиденциальности данных при использовании сгенерированных данных

## Интеграция с Рабочим Процессом Разработки

### Интеграция с Docker Compose

Система заполнения бесшовно интегрируется с существующим рабочим процессом разработки Docker:

```bash
# Запуск инфраструктуры
make docker-up

# Заполнение данных
make seed-small

# Запуск всех сервисов
make dev
```

### Интеграция CI/CD

Для автоматизированных тестовых сред:

```bash
# В пайплайне CI
make docker-up
make seed-test  # Проверка конфигурации
make seed-small # Генерация тестовых данных
make e2e-test   # Запуск тестов против заполненных данных
```

### Командное Сотрудничество

Совместное использование согласованных сред разработки:

```bash
# Руководитель команды генерирует данные
SEED_VALUE=12345 make seed-medium

# Участники команды используют то же зерно
SEED_VALUE=12345 make seed-medium
```

## Продвинутое Использование

### Пользовательская Генерация Данных

Для специализированных тестовых сценариев вы можете расширить систему заполнения:

1. **Пользовательские Виды Спорта**: Добавьте новые виды спорта в предопределённый список в `sports_data.go`
2. **Пользовательские Правила**: Измените генерацию правил конкурсов в `factory.go`
3. **Пользовательские Связи**: Настройте связи прогноз-конкурс для специфических тестовых случаев

### Оптимизация Производительности

Для больших наборов данных:

```bash
# Увеличение размера пакета для более быстрой вставки
BATCH_SIZE=500 make seed-large

# Мониторинг использования памяти во время заполнения
top -p $(pgrep seed-data)
```

### Экспорт/Импорт Данных

```bash
# Экспорт заполненных данных для совместного использования
pg_dump -U sports_user -h localhost sports_prediction > seeded_data.sql

# Импорт на другой машине
psql -U sports_user -h localhost sports_prediction < seeded_data.sql
```

## Поддержка

При проблемах с системой заполнения:

1. Проверьте раздел [Устранение Неполадок](#устранение-неполадок)
2. Проверьте предварительные требования и конфигурацию
3. Просмотрите логи для конкретных сообщений об ошибках
4. Обратитесь к основной документации проекта

Система генерации тестовых данных разработана для упрощения разработки и тестирования путём предоставления реалистичных, согласованных данных во всех функциях платформы. Используйте её регулярно для обеспечения того, чтобы ваша среда разработки оставалась заполненной значимыми тестовыми данными.
